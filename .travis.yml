language: java
jdk:
- oraclejdk8

#env:
#  - stage=QA deploy_dir=staging repo_url=https://github.com/RajeshkumarAyyadurai/securitytestv1.0.git

# Development source code would have already checkout from Github repository 
#as its already implicitly configured as part of travis configuration

# Installing required libs/softwares which are not already exist in machine
install:
- sudo apt-get install software-properties-common
- sudo apt-add-repository -y ppa:ansible/ansible
- sudo apt-get update
- sudo apt-get install ansible
- sudo apt install unzip

# Adding required privileges to the files before build
before_script:
# Deployment directory for staging environment
#- sudo mkdir /etc/ansible/$deploy_dir
#- sudo chmod 777 /etc/ansible/$deploy_dir
- sudo chmod 700 $TRAVIS_BUILD_DIR/deploy/tomcat.pem
- sudo chmod 777 $TRAVIS_BUILD_DIR/deploy/staging/ansible.cfg
- sudo mv -f $TRAVIS_BUILD_DIR/deploy/staging/ansible.cfg /etc/ansible/ansible.cfg
- sudo chmod 777 $TRAVIS_BUILD_DIR/deploy/staging/hosts
- sudo mv -f $TRAVIS_BUILD_DIR/deploy/staging/hosts /etc/ansible/hosts
- sudo chmod 777 $TRAVIS_BUILD_DIR/deploy/staging/warDeploy.yml
- sudo mv -f $TRAVIS_BUILD_DIR/deploy/staging/warDeploy.yml /etc/ansible/warDeploy.yml
 
# Executes build actions and creates java package in the form of WAR
script:
- mvn clean package

- cd /etc/ansible
- ansible-playbook warDeploy.yml
- sleep 5m

- sudo mkdir /home/travis/build/RajeshkumarAyyadurai/staging/
- sudo chmod 777 /home/travis/build/RajeshkumarAyyadurai/staging
- cd /home/travis/build/RajeshkumarAyyadurai/staging/
- git clone https://github.com/RajeshkumarAyyadurai/securitytestv1.0.git
- cd /home/travis/build/RajeshkumarAyyadurai/staging/securitytestv1.0/
- ls -l /home/travis/build/RajeshkumarAyyadurai/staging/securitytestv1.0/lib/drivers/phantomjs
- chmod 755 /home/travis/build/RajeshkumarAyyadurai/staging/securitytestv1.0/lib/drivers/phantomjs
- cd /home/travis/build/RajeshkumarAyyadurai/staging/securitytestv1.0/
- mvn test

# Deploys created WAR into AWS EC2 tomcat machine
after_success:
- sudo chmod 777 $TRAVIS_BUILD_DIR/deploy/prod/ansible.cfg
- sudo mv -f $TRAVIS_BUILD_DIR/deploy/prod/ansible.cfg /etc/ansible/ansible.cfg
- sudo chmod 777 $TRAVIS_BUILD_DIR/deploy/prod/hosts
- sudo mv -f $TRAVIS_BUILD_DIR/deploy/prod/hosts /etc/ansible/hosts
- sudo chmod 777 $TRAVIS_BUILD_DIR/deploy/prod/warDeploy.yml
- sudo mv -f $TRAVIS_BUILD_DIR/deploy/prod/warDeploy.yml /etc/ansible/warDeploy.yml

- cd /home/travis/build/RajeshkumarAyyadurai/security_app_build/
- mvn clean package

- cd /etc/ansible
- ansible-playbook warDeploy.yml
- sleep 5m

- sudo mkdir /home/travis/build/RajeshkumarAyyadurai/prod/
- sudo chmod 777 /home/travis/build/RajeshkumarAyyadurai/prod
- cd /home/travis/build/RajeshkumarAyyadurai/prod/
- git clone https://github.com/RajeshkumarAyyadurai/securitytestv1.0.git
- cd /home/travis/build/RajeshkumarAyyadurai/prod/securitytestv1.0/
- ls -l /home/travis/build/RajeshkumarAyyadurai/prod/securitytestv1.0/lib/drivers/phantomjs
- chmod 755 /home/travis/build/RajeshkumarAyyadurai/prod/securitytestv1.0/lib/drivers/phantomjs
- cd /home/travis/build/RajeshkumarAyyadurai/prod/securitytestv1.0/
- mvn test


# Sends slack notification about the build and its status
notifications:
 slack:
  on_failure: always
  on_success: always
  rooms:
  - sot-neustar:hAZy7jMtJpHHnkjpDPDsYIlD
  template:
  - "Build(#%{build_number}) triggered by %{author} %{result} in %{duration}"
  - "Repository/Branch : %{repository_name}/%{branch}"
  - "Commit : %{commit_message}"
  - "Build URL : %{build_url}"
  
#matrix:
#  include:
#    env: stage=Production deploy_dir=prod repo_url=https://github.com/RajeshkumarAyyadurai/securitytestv1.0.git