language: java
jdk:
- oraclejdk8

#env:
#  - stage=QA deploy_dir=staging repo_url=https://github.com/RajeshkumarAyyadurai/securitytestv1.0.git

# Development source code would have already checkout from Github repository 
#as its already implicitly configured as part of travis configuration

# Installing required libs/softwares which are not already exist in machine
install:
- sudo apt-get install software-properties-common
- sudo apt-add-repository -y ppa:ansible/ansible
- sudo apt-get update
- sudo apt-get install ansible
- sudo apt install unzip

# Adding required privileges to the files before build
before_script:
# Deployment directory for staging environment
#- sudo mkdir /etc/ansible/$deploy_dir
#- sudo chmod 777 /etc/ansible/$deploy_dir
- sudo rm -f /etc/ansible/ansible.cfg
- sudo rm -f /etc/ansible/hosts
- cd /etc/ansible
- ls
- sudo mkdir -p /etc/ansible/staging
- sudo chmod 777 /etc/ansible/staging
- sudo chmod 700 $TRAVIS_BUILD_DIR/deploy/tomcat.pem
- sudo chmod 777 $TRAVIS_BUILD_DIR/deploy/staging/ansible.cfg
- sudo mv -f $TRAVIS_BUILD_DIR/deploy/staging/ansible.cfg /etc/ansible/staging/ansible.cfg
- sudo chmod 777 $TRAVIS_BUILD_DIR/deploy/staging/hosts
- sudo mv -f $TRAVIS_BUILD_DIR/deploy/staging/hosts /etc/ansible/staging/hosts
- sudo chmod 777 $TRAVIS_BUILD_DIR/deploy/staging/warDeploy.yml
- sudo mv -f $TRAVIS_BUILD_DIR/deploy/staging/warDeploy.yml /etc/ansible/staging/warDeploy.yml

- sudo mkdir -p /etc/ansible/prod
- sudo chmod 777 /etc/ansible/prod
- sudo chmod 777 $TRAVIS_BUILD_DIR/deploy/prod/ansible.cfg
- sudo mv -f $TRAVIS_BUILD_DIR/deploy/prod/ansible.cfg /etc/ansible/prod/ansible.cfg
- sudo chmod 777 $TRAVIS_BUILD_DIR/deploy/prod/hosts
- sudo mv -f $TRAVIS_BUILD_DIR/deploy/prod/hosts /etc/ansible/prod/hosts
- sudo chmod 777 $TRAVIS_BUILD_DIR/deploy/prod/warDeploy.yml
- sudo mv -f $TRAVIS_BUILD_DIR/deploy/prod/warDeploy.yml /etc/ansible/prod/warDeploy.yml
 
# Executes build actions and creates java package in the form of WAR
script:
- mvn clean package

before_deploy:
- sudo chmod 777 $TRAVIS_BUILD_DIR/scripts/deploy.sh

deploy:
  - provider: script
    skip_cleanup: true
    script: $TRAVIS_BUILD_DIR/scripts/deploy.sh staging
    on:
      branch: master
  - provider: script
    skip_cleanup: true
    script: $TRAVIS_BUILD_DIR/scripts/deploy.sh production
    on:
      branch: master  

# Sends slack notification about the build and its status
notifications:
 slack:
  on_failure: always
  on_success: always
  rooms:
  - sot-neustar:hAZy7jMtJpHHnkjpDPDsYIlD
  template:
  - "Build(#%{build_number}) triggered by %{author} %{result} in %{duration}"
  - "Repository/Branch : %{repository_name}/%{branch}"
  - "Commit : %{commit_message}"
  - "Build URL : %{build_url}"